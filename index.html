<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>番茄钟</title>
	<style>
		:root{
			--bg1:#0f1724; --bg2:#07122b; --card:#071427; --glass:rgba(255,255,255,0.04);
			--accent-study:#4fd1c5; --accent-break:#60a5fa; --muted:#9aa6b2
		}
		html,body{height:100%；}
		body{margin:0;font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#f0f7fb;display:flex;align-items:center;justify-content:center;padding:28px;background:radial-gradient(1400px 700px at 8% 12%, rgba(79,209,197,0.10), transparent 8%), radial-gradient(1200px 600px at 92% 88%, rgba(96,165,250,0.09), transparent 10%), linear-gradient(180deg,#071a31,#0b2236);}

			/* subtle animated pattern */
			body::before{content:"";position:fixed;inset:0;pointer-events:none;background-image:radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);background-size:16px 16px;opacity:0.75;mix-blend-mode:overlay;animation: drift 16s linear infinite}
		@keyframes drift{from{transform:translate(0,0)}to{transform:translate(-40px,-30px)}}

		.card{width:720px;max-width:96%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:22px;box-shadow:0 10px 40px rgba(2,6,23,0.6);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.03)}

		.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
	    .help-btn{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px}
	    .help-btn:hover{color:#e6eef6;border-color:rgba(255,255,255,0.12)}
		.title{font-weight:700;font-size:18px}
		.subtitle{color:var(--muted);font-size:13px}

		.main{display:flex;gap:18px;align-items:center}

		.timer-wrap{flex:1;display:flex;flex-direction:column;align-items:center}
		.time{font-size:64px;font-weight:800;letter-spacing:1px}
		.status{color:var(--muted);margin-top:6px}

		.controls{display:flex;gap:8px;margin-top:14px}
		.btn{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
		.btn-primary{background:linear-gradient(90deg,var(--accent-study),#06b6d4);color:#032022}
		.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}

		/* totals block: single block containing both study & rest totals */
		.totals{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:12px}
		.totals h3{margin:0;font-size:14px}
		.row{display:flex;justify-content:space-between;align-items:center}
		.label{color:var(--muted);font-size:13px}
		.value{font-weight:700}
		.bars{display:flex;gap:8px}
		.bar{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;flex:1}
		.barFill{height:100%;width:0;border-radius:8px}

		/* goal badges */
		.goals{display:flex;gap:8px;align-items:center;margin-top:4px}
		.goal{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
		.goal .dot{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;color:transparent}
		.goal.completed{background:linear-gradient(90deg,var(--accent-study),#06b6d4);color:#022; font-weight:700}
		.goal.completed .dot{background:rgba(255,255,255,0.9);color:#022}

		.footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px;color:var(--muted);font-size:13px}

		@media (max-width:720px){ .main{flex-direction:column-reverse} .totals{width:100%} .time{font-size:48px} }

		/* calendar styles */
		#calendar{padding:6px}
		#calendarHeader{padding:6px;margin-bottom:6px}
		.cal-weekday{width:32px;height:20px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted)}
		.cal-day{width:32px;height:32px;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;color:var(--muted);background:transparent}
		.cal-day.today{border:1px solid rgba(255,255,255,0.06)}
		.cal-day.hasData{background:rgba(255,255,255,0.02);color:#e6eef6}
		.cal-day.selected{outline:2px solid rgba(79,209,197,0.2)}

		/* help modal / slides */
		/* intro overlay shown on first load */
		.intro-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,6,23,0.85),rgba(2,6,23,0.6));backdrop-filter:blur(6px);opacity:1;pointer-events:auto}
		.intro-modal{width:760px;max-width:94%;background:linear-gradient(180deg,#07202a,#052833);border-radius:12px;padding:22px;color:#e6eef6;box-shadow:0 20px 60px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.04)}
		.intro-modal h1{margin:0 0 6px 0;font-size:28px}
		.intro-body{color:var(--muted);line-height:1.5;margin-top:8px;white-space:pre-line}
		.help-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .2s}
		.help-overlay.open{opacity:1;pointer-events:auto}
		.help-modal{width:720px;max-width:92%;background:linear-gradient(180deg,#041622,#022532);border-radius:12px;padding:18px;color:#e6eef6;box-shadow:0 12px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
		.help-slides{overflow:hidden;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);}
		.help-track{display:flex;transition:transform .36s cubic-bezier(.2,.9,.2,1);width:100%}
		.help-slide{min-width:100%;padding:18px;box-sizing:border-box}
		.help-slide h3{margin:0 0 8px 0}
		.help-controls{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
		.help-nav{display:flex;gap:8px}
		.help-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.06)}
		.help-dot.active{background:var(--accent-study)}
		.close-help{background:transparent;border:0;color:var(--muted);cursor:pointer}
	</style>
</head>
<body>
		<div class="card" role="application" aria-label="番茄钟">
		<div class="header">
			<div>
			<div class="title">番茄钟</div>
			<div class="subtitle">25 / 5 分钟循环 · 本地保存统计</div>
			</div>
	      <div style="display:flex;align-items:center;gap:8px">
	        <div class="subtitle">周期 <strong id="cycleCount">0</strong></div>
	        <button id="helpBtn" class="help-btn">什么是番茄工作法</button>
	      </div>
		</div>

		<div class="main">
			<div class="timer-wrap">
				<div id="display" class="time" aria-live="polite">25:00</div>
				<div id="status" class="status">就绪</div>

								<div class="controls">
									<button id="start" class="btn btn-primary">开始</button>
									<button id="pause" class="btn btn-ghost" disabled>暂停</button>
									<button id="skip" class="btn btn-ghost">跳过</button>
									<button id="reset" class="btn btn-ghost">重置</button>
								</div>
			</div>

			<div class="totals" aria-live="polite">
			<h3>今日统计</h3>
						<div class="goals" aria-hidden="false">
							<div id="goal1" class="goal" title="1 小时学习目标"><span class="dot">✓</span><span>1 小时</span></div>
							<div id="goal2" class="goal" title="2 小时学习目标"><span class="dot">✓</span><span>2 小时</span></div>
						</div>
				<div class="row">
					  <div class="label">学习</div>
					  <div class="value" id="todayStudy">0m 0s</div>
				</div>
				<div class="bars">
					<div class="bar"><div id="barStudy" class="barFill" style="background:linear-gradient(90deg,var(--accent-study),#06b6d4)"></div></div>
				</div>

				<div class="row">
					  <div class="label">休息</div>
					  <div class="value" id="todayBreak">0m 0s</div>
				</div>
				<div class="bars">
					<div class="bar"><div id="barBreak" class="barFill" style="background:linear-gradient(90deg,var(--accent-break),#3b82f6)"></div></div>
				</div>

				<!-- calendar and controls -->
				<div id="calendarWrap" style="margin-top:8px">
					<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
						<div style="font-weight:700">按日统计</div>
						<div style="display:flex;gap:6px;align-items:center">
							<button id="calPrev" class="btn btn-ghost">‹</button>
							<div id="calMonthLabel" style="min-width:120px;text-align:center;color:var(--muted)"></div>
							<button id="calNext" class="btn btn-ghost">›</button>
						</div>
					</div>
					<div id="calendarHeader" style="display:grid;grid-template-columns:repeat(7,32px);gap:6px;justify-content:center;margin-bottom:6px"></div>
					<div id="calendar" style="display:grid;grid-template-columns:repeat(7,32px);gap:6px;justify-content:center"></div>
					<div id="selectedDay" style="margin-top:8px;color:var(--muted);font-size:13px">选择某一日期查看详细统计</div>
				</div>

				<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
					<label style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px"><input id="autoStart" type="checkbox"> 自动开始</label>
					<label style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-left:8px"><input id="bellEnabled" type="checkbox" checked> 铃声</label>
					<button id="stopBell" class="btn btn-ghost" title="停止铃声">停止铃声</button>
					<div style="margin-left:auto;color:var(--muted);font-size:13px">模式： <strong id="modeLabel">学习</strong></div>
				</div>
			</div>
		</div>

			<div class="footer">
				<div>所有数据保存在本地</div>
				<div><button id="clearHistory" class="btn btn-ghost">清除数据</button></div>
			</div>
	</div>

	<!-- Help modal: PPT-like slides explaining 番茄工作法 -->
	<div id="helpOverlay" class="help-overlay" aria-hidden="true">
	  <div class="help-modal" role="dialog" aria-modal="true" aria-label="什么是番茄工作法">
	    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
	      <div style="font-weight:800">什么是番茄工作法</div>
	      <button id="closeHelp" class="close-help">关闭 ✕</button>
	    </div>
	    <div class="help-slides">
	      <div id="helpTrack" class="help-track">
	        <!-- slides will be injected here -->
	      </div>
	    </div>
	    <div class="help-controls">
	      <div class="help-nav" id="helpDots"></div>
	      <div style="display:flex;gap:8px">
	        <button id="helpPrev" class="btn btn-ghost">上一步</button>
	        <button id="helpNext" class="btn btn-primary">下一步</button>
	      </div>
	    </div>
	  </div>
	</div>

		<!-- Intro overlay shown on open (starts the app) -->
		<div id="introOverlay" class="intro-overlay" aria-hidden="false">
		  <div class="intro-modal" role="dialog" aria-modal="true" aria-label="开始专注">
		    <h1>开始专注</h1>
		    <div id="introContent" class="intro-body">正在加载说明…</div>
		    <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
		      <button id="startFocusBtn" class="btn btn-primary">开始专注</button>
		    </div>
		  </div>
		</div>

	<script>
		// High-precision Pomodoro timer using performance.now() + rAF for accurate timing
		(function(){
			const STUDY_MS = 25 * 60 * 1000;
			const SHORT_BREAK_MS = 5 * 60 * 1000;
			const LONG_BREAK_MS = 30 * 60 * 1000;

			const LS_DAILY = 'pomodoroDailyTotals_v1';
			const LS_SESSIONS = 'pomodoroSessions_v1';

			const display = document.getElementById('display');
			const startBtn = document.getElementById('start');
			const pauseBtn = document.getElementById('pause');
			const resetBtn = document.getElementById('reset');
			const skipBtn = document.getElementById('skip');
			const todayStudyEl = document.getElementById('todayStudy');
			const todayBreakEl = document.getElementById('todayBreak');
			const barStudy = document.getElementById('barStudy');
			const barBreak = document.getElementById('barBreak');
			const goal1El = document.getElementById('goal1');
			const goal2El = document.getElementById('goal2');
			const autoStart = document.getElementById('autoStart');
			const bellToggle = document.getElementById('bellEnabled');
			const stopBellBtn = document.getElementById('stopBell');
			const modeLabel = document.getElementById('modeLabel');
			const status = document.getElementById('status');
			const cycleCountEl = document.getElementById('cycleCount');
			const clearHistoryBtn = document.getElementById('clearHistory');

			let mode = 'study'; // 'study' or 'break'
			let sessionDuration = STUDY_MS;

			// runtime state (high-precision)
			let running = false;
			let rafId = null;
			let perfStart = 0; // performance.now() when started
			let perfPauseAccum = 0; // total paused ms in this run
			let pauseStart = 0; // perf when pause began
			let remaining = sessionDuration; // ms remaining

			let pomodoroCount = 0;

					function setMode(m){
				mode = m;
						if(mode === 'study') sessionDuration = STUDY_MS; else sessionDuration = SHORT_BREAK_MS;
				remaining = sessionDuration;
				perfStart = 0; perfPauseAccum = 0; pauseStart = 0; running = false; updateButtons(); render();
						modeLabel.textContent = mode === 'study' ? '学习' : (isLongBreakCandidate() ? '长休息' : '休息');
			}

			function isLongBreakCandidate(){ return mode === 'break' && pomodoroCount > 0 && (pomodoroCount % 4 === 0); }

			function formatMs(ms){ ms = Math.max(0, Math.round(ms/1000)); const m = Math.floor(ms/60); const s = ms % 60; return `${m}:${String(s).padStart(2,'0')}` }

			function formatSecLabel(sec){ const m = Math.floor(sec/60); const s = sec%60; return `${m}m ${s}s` }

			function getElapsedMs(){
				// returns elapsed milliseconds for the current running/paused session (not including stored totals)
				if(!perfStart) return 0;
				let now = running ? performance.now() : (pauseStart ? pauseStart : performance.now());
				const elapsed = Math.max(0, now - perfStart - perfPauseAccum);
				return elapsed;
			}

			function updateButtons(){ startBtn.disabled = running; pauseBtn.disabled = !running; }

			function render(){ display.textContent = formatMs(remaining); cycleCountEl.textContent = pomodoroCount; }

			// animation loop
			function loop(){
				const now = performance.now();
				const elapsed = now - perfStart - perfPauseAccum;
				remaining = Math.max(0, sessionDuration - elapsed);
				render();
				// update live totals as the session runs
				renderDailyTotals();
				if(remaining <= 0){ finishSession(); return; }
				rafId = requestAnimationFrame(loop);
			}

			function start(){
				if(running) return;
				running = true;
				if(!perfStart) perfStart = performance.now();
				if(pauseStart){ perfPauseAccum += (performance.now() - pauseStart); pauseStart = 0; }
				updateButtons(); status.textContent = mode === 'study' ? '学习中…' : '休息中…';
				// if starting fresh, ensure sessionDuration reflects mode (for long break)
				if(mode === 'break' && pomodoroCount>0 && (pomodoroCount % 4 === 0)) sessionDuration = LONG_BREAK_MS;
				rafId = requestAnimationFrame(loop);
			}

			function pause(){
				if(!running) return;
				running = false;
				pauseStart = performance.now();
				if(rafId) cancelAnimationFrame(rafId); rafId = null;
				status.textContent = '已暂停'; updateButtons();
				renderDailyTotals();
			}

			function reset(){
				if(rafId) cancelAnimationFrame(rafId); rafId = null; running = false; perfStart = 0; perfPauseAccum = 0; pauseStart = 0;
				remaining = mode === 'study' ? STUDY_MS : SHORT_BREAK_MS; if(mode==='break' && isLongBreakCandidate()) remaining = LONG_BREAK_MS;
				status.textContent = '就绪'; updateButtons(); render();
				renderDailyTotals();
			}

			function finishSession(){
				// stop and commit session
				if(rafId) cancelAnimationFrame(rafId); rafId = null; running = false;
				// compute elapsed in milliseconds using performance.now() for best accuracy
				const elapsedMs = perfStart ? Math.max(0, (performance.now() - perfStart - perfPauseAccum)) : Math.max(0, sessionDuration - remaining);
				const elapsedSec = Math.max(0, Math.round(elapsedMs/1000));
				const now = Date.now();
				const startTs = new Date(now - elapsedMs).toISOString();
				const endTs = new Date(now).toISOString();
				saveSession(mode, startTs, endTs, elapsedSec);
				updateDailyTotals(mode, elapsedSec, now, now - elapsedMs);
				// play gentle bell only when completed naturally and sessionLength was 25 or 5 minutes
				const completedLength = sessionDuration; // before switching
				if(bellToggle && bellToggle.checked && (completedLength === STUDY_MS || completedLength === SHORT_BREAK_MS)){
					bellGentle();
				} else {
					// fallback short beep for other cases
					beep();
				}

				// transition
				if(mode === 'study'){
					pomodoroCount++;
					const isLong = (pomodoroCount % 4 === 0);
					mode = 'break';
					sessionDuration = isLong ? LONG_BREAK_MS : SHORT_BREAK_MS;
				} else {
					mode = 'study'; sessionDuration = STUDY_MS;
				}
				remaining = sessionDuration; perfStart = 0; perfPauseAccum = 0; pauseStart = 0;
				modeLabel.textContent = mode === 'study' ? '学习' : (isLongBreakCandidate() ? '长休息' : '休息');
				status.textContent = mode === 'study' ? '准备学习' : '休息时间';
				updateButtons(); render(); renderDailyTotals();

				if(autoStart.checked){ setTimeout(start, 600); }
			}

			function skip(){
				// record elapsed so far
				const elapsedMs = perfStart ? Math.max(0, (performance.now() - perfStart - perfPauseAccum)) : 0;
				const elapsedSec = Math.max(0, Math.round(elapsedMs/1000));
				const now = Date.now();
				const startTs = new Date(now - elapsedMs).toISOString();
				saveSession(mode, startTs, new Date().toISOString(), elapsedSec);
				updateDailyTotals(mode, elapsedSec, now, now - elapsedMs);
				// switch mode same as finish but don't auto-start here (respect autoStart below)
				if(running && rafId) cancelAnimationFrame(rafId); rafId = null; running = false;
				if(mode === 'study'){
					pomodoroCount++;
					const isLong = (pomodoroCount % 4 === 0);
					mode = 'break'; sessionDuration = isLong ? LONG_BREAK_MS : SHORT_BREAK_MS;
				} else { mode = 'study'; sessionDuration = STUDY_MS; }
				remaining = sessionDuration; perfStart = 0; perfPauseAccum = 0; pauseStart = 0;
				modeLabel.textContent = mode === 'study' ? '学习' : (isLongBreakCandidate() ? '长休息' : '休息');
				status.textContent = '已跳过'; render(); renderDailyTotals(); if(autoStart.checked) setTimeout(start, 300);
			}

			// storage helpers
			function loadDaily(){ try{ const r = localStorage.getItem(LS_DAILY); return r?JSON.parse(r):{} }catch(e){return{}} }
			function saveDaily(d){ try{ localStorage.setItem(LS_DAILY, JSON.stringify(d)); }catch(e){console.warn(e)} }
			// update daily totals and split across Beijing days if session crosses midnight
			// startMs and endMs are epoch ms. If startMs omitted, it's computed from endMs - durationSec*1000
			function updateDailyTotals(type, durationSec, endMs, startMs){
				const d = loadDaily();
				if(!endMs) endMs = Date.now();
				if(!startMs) startMs = endMs - Math.round(durationSec*1000);
				let s = startMs;
				while(s < endMs){
					const dayKey = dayKeyForMs(s);
					// Beijing midnight for dayKey -> parse as local instant with +08:00
					const dayStartMs = Date.parse(`${dayKey}T00:00:00+08:00`);
					const nextDayStart = dayStartMs + 24*60*60*1000;
					const chunkEnd = Math.min(endMs, nextDayStart);
					const chunkSec = Math.round((chunkEnd - s)/1000);
					if(!d[dayKey]) d[dayKey] = {study:0,break:0};
					d[dayKey][type] += chunkSec;
					s = chunkEnd;
				}
				saveDaily(d); renderDailyTotals();
			}
			function renderDailyTotals(){
				const d = loadDaily(); const key = dayKeyForMs(Date.now()); const stored = d[key] || {study:0,break:0};
				// include live elapsed for the currently running/paused session
				const liveMs = getElapsedMs(); const liveSec = Math.max(0, Math.round(liveMs/1000));
				let displayStudy = stored.study; let displayBreak = stored.break;
				if(perfStart){
					if(mode === 'study') displayStudy += liveSec; else displayBreak += liveSec;
				}
				todayStudyEl.textContent = formatSecLabel(displayStudy);
				todayBreakEl.textContent = formatSecLabel(displayBreak);

				// update bars relative to a dynamic max so bars show progress; base min for visual
				const max = Math.max(1, Math.max(displayStudy, displayBreak, 3600));
				barStudy.style.width = Math.min(100, Math.round((displayStudy / max) * 100)) + '%';
				barBreak.style.width = Math.min(100, Math.round((displayBreak / max) * 100)) + '%';

				// goal checks (1 hour = 3600s, 2 hours = 7200s)
				const GOAL1 = 3600; const GOAL2 = 7200;
				if(displayStudy >= GOAL1) goal1El.classList.add('completed'); else goal1El.classList.remove('completed');
				if(displayStudy >= GOAL2) goal2El.classList.add('completed'); else goal2El.classList.remove('completed');
				// refresh calendar to show per-day markers
				renderCalendar();
			}

			function loadSessions(){ try{ const r = localStorage.getItem(LS_SESSIONS); return r?JSON.parse(r):[] }catch(e){return[]} }
			function saveSessions(s){ try{ localStorage.setItem(LS_SESSIONS, JSON.stringify(s)); }catch(e){console.warn(e)} }
			function saveSession(type,startIso,endIso,durationSec){ const s = loadSessions(); s.unshift({type,start:startIso,end:endIso,durationSec}); if(s.length>500) s.length=500; saveSessions(s); }

			// Calendar: show month grid with per-day totals (use Beijing/Asia/Shanghai timezone)
			const calEl = document.getElementById('calendar');
			const calMonthLabel = document.getElementById('calMonthLabel');
			const calPrev = document.getElementById('calPrev');
			const calNext = document.getElementById('calNext');
			const selectedDayEl = document.getElementById('selectedDay');
			// helper to produce YYYY-MM-DD for Asia/Shanghai timezone
			function dayKeyForMs(ms){
				try{
					return new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Shanghai' }).format(new Date(ms));
				}catch(e){
					// fallback: compute by shifting to +08:00
					const beijing = new Date(ms + 8*60*60*1000);
					const y = beijing.getUTCFullYear(); const m = String(beijing.getUTCMonth()+1).padStart(2,'0'); const d = String(beijing.getUTCDate()).padStart(2,'0');
					return `${y}-${m}-${d}`;
				}
			}
			// initialize calendar month/year from Beijing today
			const _todayKey = dayKeyForMs(Date.now()).split('-');
			let calYear = Number(_todayKey[0]);
			let calMonth = Number(_todayKey[1]) - 1; // 0-based

			function formatKey(y,m,d){ const mm = String(m+1).padStart(2,'0'); const dd = String(d).padStart(2,'0'); return `${y}-${mm}-${dd}` }

			function renderCalendar(){
				if(!calEl) return;
				calEl.innerHTML = '';
				// render weekday header (Monday-first)
				const header = document.getElementById('calendarHeader');
				if(header){ header.innerHTML = ''; const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']; labels.forEach(l=>{ const h = document.createElement('div'); h.className='cal-weekday'; h.textContent = l; header.appendChild(h); }); }
				// compute start weekday using Beijing midnight for the 1st, convert to Monday-first index
				const first = new Date(`${calYear}-${String(calMonth+1).padStart(2,'0')}-01T00:00:00+08:00`);
				const startWeekdayRaw = first.getUTCDay(); // 0=Sun..6=Sat
				const startWeekday = (startWeekdayRaw + 6) % 7; // convert so Monday=0
				const days = new Date(calYear, calMonth+1, 0).getDate();
				// show month label
				calMonthLabel.textContent = `${calYear}年 ${calMonth+1}月`;
				const data = loadDaily();
				// fill leading empty cells
				for(let i=0;i<startWeekday;i++){ const empty = document.createElement('div'); empty.className='cal-day'; calEl.appendChild(empty); }
				// identify Beijing today
				const beijingTodayParts = dayKeyForMs(Date.now()).split('-'); const by = Number(beijingTodayParts[0]); const bm = Number(beijingTodayParts[1])-1; const bd = Number(beijingTodayParts[2]);
				for(let d=1; d<=days; d++){
					const key = formatKey(calYear, calMonth, d);
					const cell = document.createElement('div'); cell.className='cal-day';
					const stored = data[key] || {study:0,break:0};
					if(stored.study || stored.break) cell.classList.add('hasData');
					if(by===calYear && bm===calMonth && bd===d) cell.classList.add('today');
					cell.innerHTML = `<div style="font-size:11px;font-weight:700">${d}</div><div style="font-size:9px;margin-top:2px;line-height:1">${Math.floor(stored.study/60)}m</div>`;
					cell.addEventListener('click', ()=>{ selectDay(key, d, stored); document.querySelectorAll('.cal-day').forEach(c=>c.classList.remove('selected')); cell.classList.add('selected'); });
					calEl.appendChild(cell);
				}
				// auto-select today if visible
				const todayCell = calEl.querySelector('.cal-day.today');
				if(todayCell){ todayCell.click(); }
			}

			function selectDay(key, d, stored){
				selectedDayEl.innerHTML = `<div style="font-weight:700">${key}</div><div style="margin-top:6px">学习：<strong>${formatSecLabel(stored.study)}</strong></div><div style="margin-top:4px">休息：<strong>${formatSecLabel(stored.break)}</strong></div>`;
			}

			if(calPrev) calPrev.addEventListener('click', ()=>{ calMonth--; if(calMonth<0){ calMonth=11; calYear--; } renderCalendar(); });
			if(calNext) calNext.addEventListener('click', ()=>{ calMonth++; if(calMonth>11){ calMonth=0; calYear++; } renderCalendar(); });


			function beep(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value = 880; g.gain.value = 0.0001; o.connect(g); g.connect(ctx.destination); g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.02); o.start(); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 1.2); setTimeout(()=>{ o.stop(); ctx.close(); }, 1300); }catch(e){/* ignore */} }

			// gentle bell with stop capability
			let _bell = {audio:null, timeoutId:null};
			function stopBell(){
				try{
					if(_bell.timeoutId) clearTimeout(_bell.timeoutId);
					if(_bell.audio){
						_bell.audio.pause();
						_bell.audio.currentTime = 0;
					}
				}catch(e){}
				_bell = {audio:null,timeoutId:null};
			}

			function bellGentle(){
				if(!bellToggle || !bellToggle.checked) return;
				stopBell();
				try{
					const audio = new Audio('sound-of-chirping-birds-at-dawn-and-dusk-hd-261322.mp3');
					audio.volume = 1.0;
					audio.play();
					_bell.audio = audio;
					_bell.timeoutId = setTimeout(()=>{
						audio.pause();
						audio.currentTime = 0;
						_bell = {audio:null,timeoutId:null};
					}, 7000);
				}catch(e){console.warn('bell failed',e)}
			}

				// Help modal / slides logic
				const helpBtn = document.getElementById('helpBtn');
				const helpOverlay = document.getElementById('helpOverlay');
				const helpTrack = document.getElementById('helpTrack');
				const helpDots = document.getElementById('helpDots');
				const helpPrev = document.getElementById('helpPrev');
				const helpNext = document.getElementById('helpNext');
				const closeHelp = document.getElementById('closeHelp');
				let helpIndex = 0;
				const slides = [
					{title:'番茄工作法简介',body:'番茄工作法是一种时间管理方法：专注一段时间(通常25分钟)，然后短暂休息(通常5分钟)。每完成4个番茄钟后，进行一次较长的休息。'},
					{title:'如何使用本计时器',body:'点击“开始”开始学习计时；计时结束后会自动记录学习或休息时长。可开启“自动开始”让下一个会话自动运行。'},
					{title:'为什么有效',body:'短时专注能减少分心，提高注意力；定期休息可恢复精力并防止疲劳。分块工作法让大任务变得可管理。'},
					{title:'小贴士',body:'1) 在每个番茄钟开始前写下要完成的任务。\n2) 休息时离开屏幕做伸展。\n3) 若被打断，记录并在下一个番茄钟继续。'},
					{title:'开始行动',body:'现在就开始一个25分钟番茄钟，试试看效果！你可以在设置中开启或关闭铃声与自动开始。'}
				];

				function renderHelpSlides(){
					helpTrack.innerHTML = '';
					helpDots.innerHTML = '';
					slides.forEach((s, i)=>{
						const slide = document.createElement('div'); slide.className = 'help-slide';
						slide.innerHTML = `<h3>${s.title}</h3><div style="white-space:pre-line;color:var(--muted)">${s.body}</div>`;
						helpTrack.appendChild(slide);
						const dot = document.createElement('div'); dot.className='help-dot'; if(i===helpIndex) dot.classList.add('active'); helpDots.appendChild(dot);
					});
					helpTrack.style.transform = `translateX(-${helpIndex*100}%)`;
				}

				function openHelp(idx=0){ helpIndex = idx; renderHelpSlides(); helpOverlay.classList.add('open'); helpOverlay.setAttribute('aria-hidden','false'); helpNext.focus(); }
				function closeHelpModal(){ helpOverlay.classList.remove('open'); helpOverlay.setAttribute('aria-hidden','true'); helpBtn.focus(); }
				function prevHelp(){ if(helpIndex>0){ helpIndex--; helpTrack.style.transform = `translateX(-${helpIndex*100}%)`; updateDots(); } }
				function nextHelp(){ if(helpIndex < slides.length-1){ helpIndex++; helpTrack.style.transform = `translateX(-${helpIndex*100}%)`; updateDots(); } else { closeHelpModal(); } }
				function updateDots(){ Array.from(helpDots.children).forEach((d,i)=> d.classList.toggle('active', i===helpIndex)); }

				helpBtn && helpBtn.addEventListener('click', ()=> openHelp(0));
				helpPrev && helpPrev.addEventListener('click', prevHelp);
				helpNext && helpNext.addEventListener('click', nextHelp);
				closeHelp && closeHelp.addEventListener('click', closeHelpModal);
				helpOverlay && helpOverlay.addEventListener('click', (e)=>{ if(e.target===helpOverlay) closeHelpModal(); });
				document.addEventListener('keydown', (e)=>{
					if(helpOverlay.classList.contains('open')){
						if(e.key === 'Escape') closeHelpModal();
						if(e.key === 'ArrowLeft') prevHelp();
						if(e.key === 'ArrowRight') nextHelp();
					}
				});

				// Render intro overlay content using the same slides content
				const introOverlay = document.getElementById('introOverlay');
				const introContent = document.getElementById('introContent');
				const startFocusBtn = document.getElementById('startFocusBtn');
				function renderIntroFromSlides(){
					if(!introContent) return;
					let html = '';
					slides.forEach(s=>{ html += `<div style="margin-bottom:10px"><h3 style="margin:0 0 6px 0">${s.title}</h3><div style="color:var(--muted);white-space:pre-line">${s.body}</div></div>` });
					introContent.innerHTML = html;
				}
				function closeIntro(){ if(introOverlay){ introOverlay.style.display='none'; introOverlay.setAttribute('aria-hidden','true'); startBtn.focus(); } }
				// wire intro start button
				startFocusBtn && startFocusBtn.addEventListener('click', ()=>{ closeIntro(); });
				// allow Esc or Enter to close intro
				document.addEventListener('keydown', (e)=>{
					if(introOverlay && introOverlay.style.display !== 'none'){
						if(e.key === 'Escape' || e.key === 'Enter') closeIntro();
					}
				});
				renderIntroFromSlides();

			// wire events
			startBtn.addEventListener('click', start);
			pauseBtn.addEventListener('click', pause);
			resetBtn.addEventListener('click', reset);
			skipBtn.addEventListener('click', ()=>{ if(confirm('跳过当前会话？')) skip(); });
			clearHistoryBtn.addEventListener('click', ()=>{ if(!confirm('清除已保存的会话和今日统计？')) return; localStorage.removeItem(LS_SESSIONS); localStorage.removeItem(LS_DAILY); renderDailyTotals(); });
			if(stopBellBtn) stopBellBtn.addEventListener('click', stopBell);

			// init
			function init(){ pomodoroCount = 0; setMode('study'); renderDailyTotals(); }
			init();
		})();
	</script>
</body>
</html>
