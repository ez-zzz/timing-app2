<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Pomodoro — Timing</title>
	<style>
		:root{
			--bg1:#0f1724; --bg2:#07122b; --card:#071427; --glass:rgba(255,255,255,0.04);
			--accent-study:#4fd1c5; --accent-break:#60a5fa; --muted:#9aa6b2
		}
		html,body{height:100%;}
		body{margin:0;font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#f0f7fb;display:flex;align-items:center;justify-content:center;padding:28px;background:radial-gradient(1400px 700px at 8% 12%, rgba(79,209,197,0.10), transparent 8%), radial-gradient(1200px 600px at 92% 88%, rgba(96,165,250,0.09), transparent 10%), linear-gradient(180deg,#071a31,#0b2236);}

			/* subtle animated pattern */
			body::before{content:"";position:fixed;inset:0;pointer-events:none;background-image:radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);background-size:16px 16px;opacity:0.75;mix-blend-mode:overlay;animation: drift 16s linear infinite}
		@keyframes drift{from{transform:translate(0,0)}to{transform:translate(-40px,-30px)}}

		.card{width:720px;max-width:96%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:22px;box-shadow:0 10px 40px rgba(2,6,23,0.6);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.03)}

		.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
		.title{font-weight:700;font-size:18px}
		.subtitle{color:var(--muted);font-size:13px}

		.main{display:flex;gap:18px;align-items:center}

		.timer-wrap{flex:1;display:flex;flex-direction:column;align-items:center}
		.time{font-size:64px;font-weight:800;letter-spacing:1px}
		.status{color:var(--muted);margin-top:6px}

		.controls{display:flex;gap:8px;margin-top:14px}
		.btn{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
		.btn-primary{background:linear-gradient(90deg,var(--accent-study),#06b6d4);color:#032022}
		.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}

		/* totals block: single block containing both study & rest totals */
		.totals{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:12px}
		.totals h3{margin:0;font-size:14px}
		.row{display:flex;justify-content:space-between;align-items:center}
		.label{color:var(--muted);font-size:13px}
		.value{font-weight:700}
		.bars{display:flex;gap:8px}
		.bar{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;flex:1}
		.barFill{height:100%;width:0;border-radius:8px}

		/* goal badges */
		.goals{display:flex;gap:8px;align-items:center;margin-top:4px}
		.goal{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
		.goal .dot{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;color:transparent}
		.goal.completed{background:linear-gradient(90deg,var(--accent-study),#06b6d4);color:#022; font-weight:700}
		.goal.completed .dot{background:rgba(255,255,255,0.9);color:#022}

		.footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px;color:var(--muted);font-size:13px}

		@media (max-width:720px){ .main{flex-direction:column-reverse} .totals{width:100%} .time{font-size:48px} }
	</style>
</head>
<body>
	<div class="card" role="application" aria-label="Pomodoro timer">
		<div class="header">
			<div>
				<div class="title">Pomodoro Timer</div>
				<div class="subtitle">25 / 5 minute cycles · stores totals locally</div>
			</div>
			<div class="subtitle">Cycle <strong id="cycleCount">0</strong></div>
		</div>

		<div class="main">
			<div class="timer-wrap">
				<div id="display" class="time" aria-live="polite">25:00</div>
				<div id="status" class="status">Ready</div>

				<div class="controls">
					<button id="start" class="btn btn-primary">Start</button>
					<button id="pause" class="btn btn-ghost" disabled>Pause</button>
					<button id="skip" class="btn btn-ghost">Skip</button>
					<button id="reset" class="btn btn-ghost">Reset</button>
				</div>
			</div>

			<div class="totals" aria-live="polite">
				<h3>Today's totals</h3>
				<div class="goals" aria-hidden="false">
					<div id="goal1" class="goal" title="1 hour study goal"><span class="dot">✓</span><span>1 hr</span></div>
					<div id="goal2" class="goal" title="2 hour study goal"><span class="dot">✓</span><span>2 hr</span></div>
				</div>
				<div class="row">
					<div class="label">Study</div>
					<div class="value" id="todayStudy">0m 0s</div>
				</div>
				<div class="bars">
					<div class="bar"><div id="barStudy" class="barFill" style="background:linear-gradient(90deg,var(--accent-study),#06b6d4)"></div></div>
				</div>

				<div class="row">
					<div class="label">Break</div>
					<div class="value" id="todayBreak">0m 0s</div>
				</div>
				<div class="bars">
					<div class="bar"><div id="barBreak" class="barFill" style="background:linear-gradient(90deg,var(--accent-break),#3b82f6)"></div></div>
				</div>

				<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
					<label style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px"><input id="autoStart" type="checkbox"> Auto-start</label>
					<label style="font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-left:8px"><input id="bellEnabled" type="checkbox" checked> Bell</label>
					<button id="stopBell" class="btn btn-ghost" title="Stop bell sound">Stop Bell</button>
					<div style="margin-left:auto;color:var(--muted);font-size:13px">Mode: <strong id="modeLabel">Study</strong></div>
				</div>
			</div>
		</div>

		<div class="footer">
			<div>All data stored locally</div>
			<div><button id="clearHistory" class="btn btn-ghost">Clear Data</button></div>
		</div>
	</div>

	<script>
		// High-precision Pomodoro timer using performance.now() + rAF for accurate timing
		(function(){
			const STUDY_MS = 25 * 60 * 1000;
			const SHORT_BREAK_MS = 5 * 60 * 1000;
			const LONG_BREAK_MS = 30 * 60 * 1000;

			const LS_DAILY = 'pomodoroDailyTotals_v1';
			const LS_SESSIONS = 'pomodoroSessions_v1';

			const display = document.getElementById('display');
			const startBtn = document.getElementById('start');
			const pauseBtn = document.getElementById('pause');
			const resetBtn = document.getElementById('reset');
			const skipBtn = document.getElementById('skip');
			const todayStudyEl = document.getElementById('todayStudy');
			const todayBreakEl = document.getElementById('todayBreak');
			const barStudy = document.getElementById('barStudy');
			const barBreak = document.getElementById('barBreak');
			const goal1El = document.getElementById('goal1');
			const goal2El = document.getElementById('goal2');
			const autoStart = document.getElementById('autoStart');
			const bellToggle = document.getElementById('bellEnabled');
			const stopBellBtn = document.getElementById('stopBell');
			const modeLabel = document.getElementById('modeLabel');
			const status = document.getElementById('status');
			const cycleCountEl = document.getElementById('cycleCount');
			const clearHistoryBtn = document.getElementById('clearHistory');

			let mode = 'study'; // 'study' or 'break'
			let sessionDuration = STUDY_MS;

			// runtime state (high-precision)
			let running = false;
			let rafId = null;
			let perfStart = 0; // performance.now() when started
			let perfPauseAccum = 0; // total paused ms in this run
			let pauseStart = 0; // perf when pause began
			let remaining = sessionDuration; // ms remaining

			let pomodoroCount = 0;

			function setMode(m){
				mode = m;
				if(mode === 'study') sessionDuration = STUDY_MS; else sessionDuration = SHORT_BREAK_MS;
				remaining = sessionDuration;
				perfStart = 0; perfPauseAccum = 0; pauseStart = 0; running = false; updateButtons(); render();
				modeLabel.textContent = mode === 'study' ? 'Study' : (isLongBreakCandidate() ? 'Long Break' : 'Break');
			}

			function isLongBreakCandidate(){ return mode === 'break' && pomodoroCount > 0 && (pomodoroCount % 4 === 0); }

			function formatMs(ms){ ms = Math.max(0, Math.round(ms/1000)); const m = Math.floor(ms/60); const s = ms % 60; return `${m}:${String(s).padStart(2,'0')}` }

			function formatSecLabel(sec){ const m = Math.floor(sec/60); const s = sec%60; return `${m}m ${s}s` }

			function getElapsedMs(){
				// returns elapsed milliseconds for the current running/paused session (not including stored totals)
				if(!perfStart) return 0;
				let now = running ? performance.now() : (pauseStart ? pauseStart : performance.now());
				const elapsed = Math.max(0, now - perfStart - perfPauseAccum);
				return elapsed;
			}

			function updateButtons(){ startBtn.disabled = running; pauseBtn.disabled = !running; }

			function render(){ display.textContent = formatMs(remaining); cycleCountEl.textContent = pomodoroCount; }

			// animation loop
			function loop(){
				const now = performance.now();
				const elapsed = now - perfStart - perfPauseAccum;
				remaining = Math.max(0, sessionDuration - elapsed);
				render();
				// update live totals as the session runs
				renderDailyTotals();
				if(remaining <= 0){ finishSession(); return; }
				rafId = requestAnimationFrame(loop);
			}

			function start(){
				if(running) return;
				running = true;
				if(!perfStart) perfStart = performance.now();
				if(pauseStart){ perfPauseAccum += (performance.now() - pauseStart); pauseStart = 0; }
				updateButtons(); status.textContent = mode === 'study' ? 'Studying…' : 'On break…';
				// if starting fresh, ensure sessionDuration reflects mode (for long break)
				if(mode === 'break' && pomodoroCount>0 && (pomodoroCount % 4 === 0)) sessionDuration = LONG_BREAK_MS;
				rafId = requestAnimationFrame(loop);
			}

			function pause(){
				if(!running) return;
				running = false;
				pauseStart = performance.now();
				if(rafId) cancelAnimationFrame(rafId); rafId = null;
				status.textContent = 'Paused'; updateButtons();
				renderDailyTotals();
			}

			function reset(){
				if(rafId) cancelAnimationFrame(rafId); rafId = null; running = false; perfStart = 0; perfPauseAccum = 0; pauseStart = 0;
				remaining = mode === 'study' ? STUDY_MS : SHORT_BREAK_MS; if(mode==='break' && isLongBreakCandidate()) remaining = LONG_BREAK_MS;
				status.textContent = 'Ready'; updateButtons(); render();
				renderDailyTotals();
			}

			function finishSession(){
				// stop and commit session
				if(rafId) cancelAnimationFrame(rafId); rafId = null; running = false;
				// compute elapsed in seconds
				const elapsedMs = sessionDuration - remaining;
				const elapsedSec = Math.max(0, Math.round(elapsedMs/1000));
				const now = Date.now();
				const startTs = new Date(now - elapsedMs).toISOString();
				const endTs = new Date(now).toISOString();
				saveSession(mode, startTs, endTs, elapsedSec);
				updateDailyTotals(mode, elapsedSec);
				beep();

				// transition
				if(mode === 'study'){
					pomodoroCount++;
					const isLong = (pomodoroCount % 4 === 0);
					mode = 'break';
					sessionDuration = isLong ? LONG_BREAK_MS : SHORT_BREAK_MS;
				} else {
					mode = 'study'; sessionDuration = STUDY_MS;
				}
				remaining = sessionDuration; perfStart = 0; perfPauseAccum = 0; pauseStart = 0;
				modeLabel.textContent = mode === 'study' ? 'Study' : (isLongBreakCandidate() ? 'Long Break' : 'Break');
				status.textContent = mode === 'study' ? 'Ready to study' : 'Break time';
				updateButtons(); render(); renderDailyTotals();

				if(autoStart.checked){ setTimeout(start, 600); }
			}

			function skip(){
				// record elapsed so far
				const elapsedMs = perfStart ? Math.max(0, (performance.now() - perfStart - perfPauseAccum)) : 0;
				const elapsedSec = Math.max(0, Math.round(elapsedMs/1000));
				const now = Date.now();
				const startTs = new Date(now - elapsedMs).toISOString();
				saveSession(mode, startTs, new Date().toISOString(), elapsedSec);
				updateDailyTotals(mode, elapsedSec);
				// switch mode same as finish but don't auto-start here (respect autoStart below)
				if(running && rafId) cancelAnimationFrame(rafId); rafId = null; running = false;
				if(mode === 'study'){
					pomodoroCount++;
					const isLong = (pomodoroCount % 4 === 0);
					mode = 'break'; sessionDuration = isLong ? LONG_BREAK_MS : SHORT_BREAK_MS;
				} else { mode = 'study'; sessionDuration = STUDY_MS; }
				remaining = sessionDuration; perfStart = 0; perfPauseAccum = 0; pauseStart = 0;
				modeLabel.textContent = mode === 'study' ? 'Study' : (isLongBreakCandidate() ? 'Long Break' : 'Break');
				status.textContent = 'Skipped'; render(); renderDailyTotals(); if(autoStart.checked) setTimeout(start, 300);
			}

			// storage helpers
			function loadDaily(){ try{ const r = localStorage.getItem(LS_DAILY); return r?JSON.parse(r):{} }catch(e){return{}} }
			function saveDaily(d){ try{ localStorage.setItem(LS_DAILY, JSON.stringify(d)); }catch(e){console.warn(e)} }
			function updateDailyTotals(type, durationSec){ const d = loadDaily(); const key = (new Date()).toISOString().slice(0,10); if(!d[key]) d[key] = {study:0,break:0}; if(type==='study') d[key].study += durationSec; else d[key].break += durationSec; saveDaily(d); renderDailyTotals(); }
			function renderDailyTotals(){
				const d = loadDaily(); const key = (new Date()).toISOString().slice(0,10); const stored = d[key] || {study:0,break:0};
				// include live elapsed for the currently running/paused session
				const liveMs = getElapsedMs(); const liveSec = Math.max(0, Math.round(liveMs/1000));
				let displayStudy = stored.study; let displayBreak = stored.break;
				if(perfStart){
					if(mode === 'study') displayStudy += liveSec; else displayBreak += liveSec;
				}
				todayStudyEl.textContent = formatSecLabel(displayStudy);
				todayBreakEl.textContent = formatSecLabel(displayBreak);

				// update bars relative to a dynamic max so bars show progress; base min for visual
				const max = Math.max(1, Math.max(displayStudy, displayBreak, 3600));
				barStudy.style.width = Math.min(100, Math.round((displayStudy / max) * 100)) + '%';
				barBreak.style.width = Math.min(100, Math.round((displayBreak / max) * 100)) + '%';

				// goal checks (1 hour = 3600s, 2 hours = 7200s)
				const GOAL1 = 3600; const GOAL2 = 7200;
				if(displayStudy >= GOAL1) goal1El.classList.add('completed'); else goal1El.classList.remove('completed');
				if(displayStudy >= GOAL2) goal2El.classList.add('completed'); else goal2El.classList.remove('completed');
			}

			function loadSessions(){ try{ const r = localStorage.getItem(LS_SESSIONS); return r?JSON.parse(r):[] }catch(e){return[]} }
			function saveSessions(s){ try{ localStorage.setItem(LS_SESSIONS, JSON.stringify(s)); }catch(e){console.warn(e)} }
			function saveSession(type,startIso,endIso,durationSec){ const s = loadSessions(); s.unshift({type,start:startIso,end:endIso,durationSec}); if(s.length>500) s.length=500; saveSessions(s); }

			function beep(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value = 880; g.gain.value = 0.0001; o.connect(g); g.connect(ctx.destination); g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.02); o.start(); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 1.2); setTimeout(()=>{ o.stop(); ctx.close(); }, 1300); }catch(e){/* ignore */} }

			// wire events
			startBtn.addEventListener('click', start);
			pauseBtn.addEventListener('click', pause);
			resetBtn.addEventListener('click', reset);
			skipBtn.addEventListener('click', ()=>{ if(confirm('Skip current session?')) skip(); });
			clearHistoryBtn.addEventListener('click', ()=>{ if(!confirm('Clear stored sessions and daily totals?')) return; localStorage.removeItem(LS_SESSIONS); localStorage.removeItem(LS_DAILY); renderDailyTotals(); });

			// init
			function init(){ pomodoroCount = 0; setMode('study'); renderDailyTotals(); }
			init();
		})();
	</script>
</body>
</html>
